# 富文本优化 & 回忆录模板 - 更新文档

## 更新日期
2025年10月23日

## 更新概览

本次更新主要解决了两个关键问题：
1. **优化富文本呈现**：完善 Tiptap JSON 格式规范，确保生成的日记在富文本编辑器中完美呈现
2. **新增回忆录大师模板**：创建业内顶级的回忆录风格模板，参考畅销回忆录大师的写作技巧

---

## 一、富文本格式优化 ✨

### 问题分析

之前生成的日记在富文本编辑器中可能存在以下问题：
- 字体颜色等格式未正确应用
- JSON 格式不够标准化
- 富文本元素使用不充分
- 缺乏统一的格式规范

### 解决方案

#### 1. 完善格式规范文档

在所有 Prompt 中统一了 **Tiptap JSON 标准格式**，包括：

**颜色标记**（情感关键词）：
```json
{"type": "text", "marks": [{"type": "textStyle", "attrs": {"color": "#f59e0b"}}], "text": "温暖文字"}
```

支持的颜色：
- 温暖/喜悦：`#f59e0b` (琥珀色)
- 强烈/激动：`#10b981` (翠绿色)
- 平静/思考：`#3b82f6` (天蓝色)
- 忧伤/困惑：`#6366f1` (靛蓝色)
- 浪漫/温柔：`#ec4899` (粉红色)

**粗体强调**：
```json
{"type": "text", "marks": [{"type": "bold"}], "text": "粗体文字"}
```

**斜体**（内心独白）：
```json
{"type": "text", "marks": [{"type": "italic"}], "text": "斜体文字"}
```

**高亮**（Aha moment、顿悟）：
```json
{"type": "text", "marks": [{"type": "highlight", "attrs": {"color": "#fef3c7"}}], "text": "高亮文字"}
```

支持的高亮色：
- 浅黄色：`#fef3c7` (重要领悟)
- 浅绿色：`#d1fae5` (人生智慧)

**组合标记**（多种格式叠加）：
```json
{
  "type": "text", 
  "marks": [
    {"type": "bold"}, 
    {"type": "textStyle", "attrs": {"color": "#f59e0b"}}
  ], 
  "text": "粗体彩色文字"
}
```

#### 2. 段落结构规范

**标题层次**：
- H3：主标题（日期、时间节点）
- H4：副标题（场景切换）

**引用块**：
```json
{
  "type": "blockquote",
  "content": [
    {
      "type": "paragraph",
      "content": [
        {"type": "text", "marks": [{"type": "italic"}], "text": "哲思内容"}
      ]
    }
  ]
}
```

**分隔线**：
```json
{"type": "horizontalRule"}
```

**列表**（回忆录特别有用）：
```json
{
  "type": "bulletList",
  "content": [
    {
      "type": "listItem",
      "content": [
        {
          "type": "paragraph",
          "content": [{"type": "text", "text": "列表项"}]
        }
      ]
    }
  ]
}
```

#### 3. 使用建议

**适度原则**：
- 每段最多 2-3 处颜色标记
- 每段最多 1-2 处粗体强调
- 高亮用于真正的 Aha moment
- 避免过度装饰，保持阅读流畅性

**格式要点**：
- `marks` 必须是数组，即使只有一个标记
- 所有文本必须在块级节点内（paragraph、heading 等）
- 颜色、高亮、粗体、斜体用于真正重要的地方

---

## 二、回忆录大师模板 📖

### 设计理念

参考世界顶级畅销回忆录：
- 《成为》- 米歇尔·奥巴马
- 《你当像鸟飞往你的山》- 塔拉·韦斯特弗
- 《我的天才女友》- 埃莱娜·费兰特
- 《一切都结束了，除了呐喊》- Rick Bragg

### 核心特点

#### 1. 击中 Aha Moment

每篇回忆录必须包含至少一个让读者"啊，原来如此"的顿悟时刻：

**五种 Aha Moment 类型**：
1. **重新理解型**："原来那时候他说那句话，是因为..."
2. **突然领悟型**："直到今天我才明白，当年的选择意味着..."
3. **连接发现型**："原来这两件看似无关的事，竟然有这样的联系"
4. **自我认知型**："我一直以为自己是...其实我是..."
5. **遗憾和解型**："如果能回到过去，我会告诉那时的自己..."

#### 2. 摒弃固定模板

**灵活的叙事结构**（根据内容选择）：
- **对比式**：过去的我以为...现在的我明白...
- **顿悟式**：从平常时刻突然理解了多年前的某个瞬间
- **追溯式**：今天的某个细节，让我想起了那年...
- **对话式**：与过去的自己对话，与记忆中的人对话
- **连锁式**：这件事让我想起那件事，原来一切都有联系

#### 3. 双重视角

**核心原则**：
- 站在现在回望过去
- 用时间的沉淀重新理解当时的自己
- 不只记录"发生了什么"，更要探索"为什么"和"这改变了什么"
- 在当下、过去、更早的回忆之间自由穿梭

#### 4. 情感真实

**诚实勇气**：
- 直面真实的情感，包括痛苦、羞愧、困惑、遗憾
- 不回避矛盾：承认当时的错误、幼稚、误解
- 展现成长：对比当时和现在对同一事情的不同理解
- 情感真实：允许复杂、矛盾、说不清的情绪

#### 5. 充分利用富文本

**特色富文本应用**：

1. **标题层次**：
   - H3：时间节点（"2015年夏天"、"十年后的今天"）
   - H4：场景切换（"那天下午"、"回到现在"）

2. **颜色语义化**：
   - 温暖/喜悦 (#f59e0b)：温馨的回忆、美好的时刻
   - 强烈/激动 (#10b981)：重要转折、人生关键选择
   - 平静/思考 (#3b82f6)：深度反思、哲理思考
   - 忧伤/困惑 (#6366f1)：痛苦记忆、未解之谜
   - 浪漫/温柔 (#ec4899)：爱、友情、温柔时刻

3. **高亮 Aha Moment**：
   - 浅黄色背景 (#fef3c7)：关键领悟
   - 浅绿色背景 (#d1fae5)：人生智慧

4. **引用块的妙用**：
   - 记忆中的对话
   - 核心领悟和人生感悟
   - 与过去自己的对话

5. **分隔线的作用**：
   - 分隔不同的时间线
   - 标记叙事视角的切换（过去↔现在）

6. **列表的运用**：
   - 梳理人生的关键时刻
   - 列举多个小的顿悟
   - 对比"当时"和"现在"的想法

7. **组合标记**：
   - **粗体+颜色**：最重要的关键词
   - **斜体**：内心独白、未说出口的话
   - **高亮+粗体**：核心 Aha Moment

### 示例结构

```
开场：从今天的某个瞬间开始
    ↓
回忆触发：这个瞬间让我想起了...
    ↓
深入回忆：详细描述那段往事（用细节、对话、情感）
    ↓
时空穿梭：也许还会想起更早的记忆
    ↓
重新理解：现在的我如何看待当时的自己
    ↓
Aha Moment：突然的领悟（高亮显示）
    ↓
回到现在：这段回忆如何影响了现在的我
    ↓
余韵：未尽的思考，开放的结尾
```

### 经典示例句式

**示例一：重新理解**
> "多年以后，当我再次路过那条街，才终于明白——那个下午，父亲沉默地转身离开，不是因为失望，而是因为不知道如何表达关心。那时的我，把他的沉默理解成了冷漠。"

**示例二：突然领悟**
> "今天有人问我：'你什么时候开始变得勇敢？'我想了很久，脑海中浮现的，竟是那个在被窝里偷偷哭泣的夜晚。原来勇敢不是不怕，而是即使怕得要死，第二天还是起床出门。"

**示例三：连接发现**
> "翻到这张照片时，我突然意识到——那年夏天我们拼命想要逃离的小镇，如今却成了我最怀念的地方。不是小镇变了，是我终于理解了，真正珍贵的从来不是地方，而是那时候还在一起的我们。"

### 真实感与感染力

**真实细节**：
- 具体的时间、地点、对话、表情、动作
- 气味、声音、光线、温度等感官细节

**真实情感**：
- 不掩饰脆弱、困惑、后悔、矛盾
- 不回避负面情绪
- 诚实到残酷，但不自怜

**真实思考**：
- 展现思考的过程，而非完美的结论
- 允许未解之谜，不是所有事都有完美答案

**真实人物**：
- 人是复杂的
- 好人也有缺点，坏人也有温柔时刻

**真实成长**：
- 承认错误，展现改变
- 但不美化过去，不过度解读

### 必须做到

✅ 至少一个让人"啊，原来如此"的 Aha Moment（高亮显示）
✅ 至少一处时空对比（过去 vs 现在）
✅ 至少一处情感的诚实剖析
✅ 至少一个具体的人生智慧（引用块）
✅ 充分利用颜色、高亮、粗体、斜体等富文本格式
✅ 至少使用一次列表或对比结构
✅ 结尾留有余韵，不要过度总结

### 禁止的陈词滥调

❌ "往事如烟"
❌ "时光荏苒"
❌ "蓦然回首"
❌ "青春不再"
❌ "如梦如幻"
❌ 任何空洞的感叹

---

## 三、技术实现

### 修改的文件

1. **`src/lib/ai/diary/prompts-master.ts`**
   - 完善了通用的 Tiptap JSON 格式说明
   - 新增了详细的富文本格式规范
   - 新增了回忆录大师风格的完整 Prompt (case 'memoir')
   - 优化了所有作家风格的格式说明

2. **`src/lib/ai/diary/writer-styles.ts`**
   - 新增回忆录大师作家定义
   - ID: `memoir`
   - 名称：回忆录大师 (Memoir Master)
   - 风格：回忆录 · 纪实文学
   - 颜色：棕色系 (#92400e → #d97706)
   - 图标：📖

### 作家总数

现在共有 **12 位作家**：
1. 海明威 - 冰山理论
2. 伍尔夫 - 意识流
3. 村上春树 - 都市孤独
4. 马尔克斯 - 魔幻现实
5. 卡夫卡 - 荒诞异化
6. 萨冈 - 慵懒优雅
7. 王尔德 - 机智悖论
8. 普拉斯 - 自白派
9. 卡尔维诺 - 轻盈奇幻
10. 奥威尔 - 清晰诚实
11. 安房直子 - 温柔幻想
12. **回忆录大师** - 时光沉淀中的人生智慧 ⭐ 新增

---

## 四、使用指南

### 如何使用回忆录模板

1. 在日记生成页面选择"回忆录大师"卡片
2. 系统会自动应用回忆录风格的 Prompt
3. AI 将：
   - 从当天的生活片段中寻找可以深度挖掘的素材
   - 建立当下与过去的连接
   - 创造至少一个 Aha Moment
   - 充分利用富文本格式增强表现力
   - 以成熟的视角审视和理解经历

### 适用场景

回忆录模板特别适合：
- 想要深度反思的日子
- 遇到触发回忆的事件
- 对过去有新的理解
- 人生重要节点的回顾
- 想要记录成长和变化

### 与日记的区别

| 特点 | 普通日记 | 回忆录 |
|------|---------|--------|
| 时间视角 | 当下 | 现在回望过去 |
| 深度 | 记录发生的事 | 探索意义和影响 |
| 情感 | 当下的感受 | 时间沉淀后的理解 |
| 结构 | 时间顺序 | 时空交织 |
| 目标 | 记录生活 | 提炼智慧 |

---

## 五、富文本最佳实践

### 颜色使用建议

**适度原则**：
- 每段最多 2-3 处颜色标记
- 用于真正重要的情感关键词
- 避免过度使用导致花里胡哨

**语义化使用**：
- 温暖色 → 美好、温馨、喜悦
- 绿色 → 强烈、转折、关键
- 蓝色 → 平静、思考、理性
- 靛蓝 → 忧伤、困惑、疑问
- 粉色 → 浪漫、温柔、爱

### 高亮使用建议

**慎用原则**：
- 仅用于真正的 Aha Moment
- 每篇最多 1-2 处高亮
- 必须是真正让人眼前一亮的领悟

**组合使用**：
- 高亮 + 粗体 → 最核心的顿悟
- 高亮 + 斜体 → 内心的重要认知

### 引用块使用建议

**适用场景**：
- 重要的对话（真实的或记忆中的）
- 核心的人生感悟
- 哲理性的思考
- 与过去自己的对话

### 分隔线使用建议

**功能定位**：
- 场景切换
- 时间线切换（过去 ↔ 现在）
- 叙事视角转换
- 主题过渡

---

## 六、质量保证

### 格式验证

系统已有的格式验证机制：
- `deepFixTiptapJSON()` - 自动修复常见格式错误
- `validateTiptapJSON()` - 验证 JSON 结构正确性
- 自动将 textStyle 节点转换为正确的 marks 格式

### AI 模型优化

生成器设置：
- 模型：GPT-4o（最适合创意写作和叙事）
- Temperature：0.9（高创造性）
- System Prompt：强调传记作家身份
- 详细的格式规范说明

---

## 七、预期效果

### 富文本呈现

- ✅ 颜色准确应用，情感关键词醒目
- ✅ 粗体、斜体、高亮正确显示
- ✅ 引用块、分隔线、列表结构清晰
- ✅ 组合标记正确渲染
- ✅ 整体排版美观易读

### 回忆录质量

- ✅ 每篇都有至少一个 Aha Moment
- ✅ 时空交织，双重视角明显
- ✅ 情感真实，不回避矛盾
- ✅ 文字感染力强，引发共鸣
- ✅ 充分利用富文本增强表现力
- ✅ 摒弃固定模板，结构灵活多变

---

## 八、未来改进方向

1. **个性化调整**：根据用户写作习惯调整格式使用频率
2. **样式主题**：提供多种配色主题供用户选择
3. **回忆检索**：智能关联历史记录，自动提示相关回忆
4. **时间轴视图**：可视化展示人生关键时刻
5. **Aha Moment 集锦**：自动收集所有顿悟时刻

---

## 九、相关文件

- `src/lib/ai/diary/prompts-master.ts` - Prompt 核心文件
- `src/lib/ai/diary/writer-styles.ts` - 作家风格定义
- `src/lib/ai/diary/tiptap-config.ts` - Tiptap 配置
- `src/lib/ai/diary/json-fixer.ts` - JSON 格式修复
- `src/lib/ai/diary/generator.ts` - 日记生成器

---

**更新时间**: 2025-10-23  
**作者**: AI Assistant  
**版本**: 2.0  
**状态**: ✅ 完成，无 linter 错误

